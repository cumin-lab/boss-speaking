<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç™»å£‡ç®¡ç† â€” Boss Speaking</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f4f0;
    --surface: #ffffff;
    --surface2: #f0efe9;
    --border: #e0ddd5;
    --accent: #9a7340;
    --accent2: #b8894e;
    --text: #1a1a18;
    --text-muted: #888070;
    --green: #2e8a5e;
    --yellow: #b8860b;
    --red: #c0392b;
    --blue: #2a6db5;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans JP', sans-serif;
    font-weight: 300;
    min-height: 100vh;
  }

  /* Header */
  header {
    padding: 32px 40px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    background: linear-gradient(180deg, #edeae2 0%, var(--bg) 100%);
  }

  .header-left h1 {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    color: var(--accent);
    letter-spacing: 0.02em;
  }

  .header-left p {
    color: var(--text-muted);
    font-size: 13px;
    margin-top: 4px;
    letter-spacing: 0.05em;
  }

  .btn-add {
    background: var(--accent);
    color: #ffffff;
    border: none;
    padding: 10px 22px;
    border-radius: 6px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: background 0.2s;
  }

  .btn-add:hover { background: var(--accent2); }

  /* Stats bar */
  .stats {
    display: flex;
    gap: 1px;
    background: var(--border);
    border-bottom: 1px solid var(--border);
  }

  .stat {
    flex: 1;
    background: var(--surface);
    padding: 16px 24px;
    text-align: center;
  }

  .stat-num {
    font-size: 26px;
    font-weight: 700;
    color: var(--accent);
    font-family: 'Playfair Display', serif;
  }

  .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; letter-spacing: 0.08em; }

  /* Filters */
  .filters {
    padding: 16px 40px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }

  .filter-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 6px 16px;
    border-radius: 20px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .filter-btn.active, .filter-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(201,169,110,0.08);
  }

  .search-input {
    margin-left: auto;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 7px 16px;
    border-radius: 20px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 12px;
    width: 200px;
    outline: none;
    transition: border-color 0.2s;
  }

  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text-muted); }

  /* Table */
  .table-wrap { padding: 24px 40px; overflow-x: auto; }

  table { width: 100%; border-collapse: collapse; }

  thead tr {
    border-bottom: 2px solid var(--border);
  }

  th {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-align: left;
    padding: 0 12px 12px;
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    cursor: pointer;
  }

  tbody tr:hover { background: var(--surface); }

  td {
    padding: 14px 12px;
    font-size: 13px;
    vertical-align: top;
  }

  .td-title { font-weight: 500; color: var(--text); }
  .td-sub { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

  /* Status badge */
  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.04em;
    white-space: nowrap;
  }

  .badge-æ¤œè¨ä¸­ { background: rgba(92,158,224,0.15); color: var(--blue); }
  .badge-ç¢ºå®š { background: rgba(76,175,130,0.15); color: var(--green); }
  .badge-å®Œäº† { background: rgba(136,136,153,0.15); color: var(--text-muted); }
  .badge-è¾é€€ { background: rgba(224,92,92,0.15); color: var(--red); }

  .cat-badge {
    display: inline-block;
    padding: 2px 9px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.04em;
    white-space: nowrap;
  }
  .cat-ç™»å£‡ { background: rgba(201,169,110,0.15); color: var(--accent); border: 1px solid rgba(201,169,110,0.3); }
  .cat-å–æ { background: rgba(160,110,210,0.15); color: #c87de8; border: 1px solid rgba(160,110,210,0.3); }
  .cat-å‡ºæ¼” { background: rgba(76,175,200,0.15); color: #4cc4c0; border: 1px solid rgba(76,175,200,0.3); }

  /* Deadline warning */
  .deadline-warn { color: var(--red); font-weight: 500; }
  .deadline-near { color: var(--yellow); font-weight: 500; }

  /* Action buttons */
  .actions { display: flex; gap: 8px; }

  .btn-edit, .btn-del {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 4px 12px;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    font-family: 'Noto Sans JP', sans-serif;
    transition: all 0.2s;
  }

  .btn-edit:hover { border-color: var(--accent); color: var(--accent); }
  .btn-del:hover { border-color: var(--red); color: var(--red); }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-state .icon { font-size: 40px; margin-bottom: 12px; }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 580px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
    padding: 32px;
    animation: slideUp 0.2s ease;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .modal h2 {
    font-family: 'Playfair Display', serif;
    color: var(--accent);
    font-size: 20px;
    margin-bottom: 24px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: span 2; }

  label { font-size: 11px; color: var(--text-muted); letter-spacing: 0.08em; }

  input, select, textarea {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 9px 12px;
    border-radius: 6px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  textarea { resize: vertical; min-height: 80px; }

  select option { background: #ffffff; color: var(--text); }

  .modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }

  .btn-cancel {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 9px 20px;
    border-radius: 6px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-cancel:hover { border-color: var(--text-muted); color: var(--text); }

  .btn-save {
    background: var(--accent);
    border: none;
    color: #ffffff;
    padding: 9px 24px;
    border-radius: 6px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-save:hover { background: var(--accent2); }

  @media (max-width: 768px) {
    header { flex-direction: column; align-items: flex-start; gap: 16px; padding: 24px 20px 20px; }
    .filters { padding: 12px 20px; }
    .table-wrap { padding: 16px 20px; }
    .form-grid { grid-template-columns: 1fr; }
    .form-group.full { grid-column: span 1; }
    .stats .stat { padding: 12px 8px; }
    .stat-num { font-size: 20px; }
  }

  /* Loading bar */
  #loadingBar {
    display: none;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2), var(--accent));
    background-size: 200% 100%;
    animation: shimmer 1.2s infinite;
  }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Toast */
  #toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 13px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s;
    z-index: 200;
    white-space: nowrap;
  }

  #toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Error */
  #errorMsg {
    display: none;
    background: rgba(192,57,43,0.08);
    border: 1px solid rgba(192,57,43,0.25);
    color: var(--red);
    padding: 10px 20px;
    font-size: 13px;
    text-align: center;
  }
</style>
</head>
<body>

<div id="loadingBar"></div>
<div id="errorMsg"></div>
<div id="toast"></div>

<header>
  <div class="header-left">
    <h1>Boss Speaking Manager</h1>
    <p>ç™»å£‡ä¾é ¼ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</p>
  </div>
  <button class="btn-add" onclick="openModal()">ï¼‹ æ–°è¦ç™»å£‡ä¾é ¼ã‚’è¿½åŠ </button>
</header>

<div class="stats">
  <div class="stat"><div class="stat-num" id="stat-total">0</div><div class="stat-label">ç·ä»¶æ•°</div></div>
  <div class="stat"><div class="stat-num" id="stat-kentou" style="color:var(--blue)">0</div><div class="stat-label">æ¤œè¨ä¸­</div></div>
  <div class="stat"><div class="stat-num" id="stat-kakutei" style="color:var(--green)">0</div><div class="stat-label">ç¢ºå®š</div></div>
  <div class="stat"><div class="stat-num" id="stat-kanryo" style="color:var(--text-muted)">0</div><div class="stat-label">å®Œäº†</div></div>
  <div class="stat"><div class="stat-num" id="stat-jirai" style="color:var(--red)">0</div><div class="stat-label">è¾é€€</div></div>
</div>

<div class="filters">
  <button class="filter-btn active" onclick="setFilter('all', this)">ã™ã¹ã¦</button>
  <button class="filter-btn" onclick="setFilter('æ¤œè¨ä¸­', this)">æ¤œè¨ä¸­</button>
  <button class="filter-btn" onclick="setFilter('ç¢ºå®š', this)">ç¢ºå®š</button>
  <button class="filter-btn" onclick="setFilter('å®Œäº†', this)">å®Œäº†</button>
  <button class="filter-btn" onclick="setFilter('è¾é€€', this)">è¾é€€</button>
  <input class="search-input" type="text" placeholder="ğŸ” æ¤œç´¢..." id="searchInput" oninput="renderTable()">
</div>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>ç™»å£‡æ—¥</th>
        <th>ã‚«ãƒ†ã‚´ãƒª</th>
        <th>ãƒ†ãƒ¼ãƒãƒ»ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th>ä¾é ¼å…ƒãƒ»ä¸»å‚¬è€…</th>
        <th>å ´æ‰€</th>
        <th>ç™»å£‡æ–™</th>
        <th>è³‡æ–™æå‡ºæœŸé™</th>
        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div class="empty-state" id="emptyState" style="display:none">
    <div class="icon">ğŸ“‹</div>
    <div>ç™»å£‡ä¾é ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œæ–°è¦ç™»å£‡ä¾é ¼ã‚’è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <h2 id="modalTitle">ç™»å£‡ä¾é ¼ã‚’è¿½åŠ </h2>
    <div class="form-grid">
      <div class="form-group full">
        <label>ãƒ†ãƒ¼ãƒãƒ»ã‚¿ã‚¤ãƒˆãƒ« *</label>
        <input type="text" id="f-title" placeholder="ä¾‹ï¼šDXæ¨é€²ã¨æœªæ¥ã®åƒãæ–¹">
      </div>
      <div class="form-group">
        <label>ã‚«ãƒ†ã‚´ãƒª</label>
        <select id="f-category">
          <option value="ç™»å£‡">ç™»å£‡</option>
          <option value="å–æ">å–æ</option>
          <option value="å‡ºæ¼”">å‡ºæ¼”</option>
        </select>
      </div>
      <div class="form-group">
        <label>ä¾é ¼å…ƒãƒ»ä¸»å‚¬è€… *</label>
        <input type="text" id="f-organizer" placeholder="ä¾‹ï¼šã€‡ã€‡å”ä¼š">
      </div>
      <div class="form-group">
        <label>æ‹…å½“è€…ãƒ»é€£çµ¡å…ˆ</label>
        <input type="text" id="f-contact" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ / 03-xxxx-xxxx">
      </div>
      <div class="form-group">
        <label>ç™»å£‡æ—¥æ™‚ *</label>
        <input type="datetime-local" id="f-date">
      </div>
      <div class="form-group">
        <label>å ´æ‰€</label>
        <input type="text" id="f-place" placeholder="ä¾‹ï¼šæ±äº¬å›½éš›ãƒ•ã‚©ãƒ¼ãƒ©ãƒ  B7">
      </div>
      <div class="form-group">
        <label>ç™»å£‡æ–™</label>
        <input type="text" id="f-fee" placeholder="ä¾‹ï¼š200,000å†† / ç„¡å„Ÿ">
      </div>
      <div class="form-group">
        <label>è³‡æ–™æå‡ºæœŸé™</label>
        <input type="date" id="f-deadline">
      </div>
      <div class="form-group">
        <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
        <select id="f-status">
          <option value="æ¤œè¨ä¸­">æ¤œè¨ä¸­</option>
          <option value="ç¢ºå®š">ç¢ºå®š</option>
          <option value="å®Œäº†">å®Œäº†</option>
          <option value="è¾é€€">è¾é€€</option>
        </select>
      </div>
      <div class="form-group full">
        <label>å†…å®¹ãƒ¡ãƒ¢</label>
        <textarea id="f-memo" placeholder="ãƒ†ãƒ¼ãƒè©³ç´°ã€ç‰¹è¨˜äº‹é …ã€æº–å‚™ãƒ¡ãƒ¢ãªã©..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-save" onclick="saveRecord()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
  // â”€â”€ Supabase è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SUPABASE_URL = 'https://xcaurnunhjvzoqkosytc.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjYXVybnVuaGp2em9xa29zeXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzQ2NTEsImV4cCI6MjA4NzQ1MDY1MX0.sJN5lxn6D_XCCazz0lgkYjXjgzpFBZjnq_IKqxymXNs';
  const TABLE = 'speaking_requests';

  async function sbFetch(path, options = {}) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': options.prefer || '',
        ...options.headers
      },
      ...options
    });
    if (!res.ok) {
      const err = await res.text();
      throw new Error(err);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  }

  // â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let records = [];
  let currentFilter = 'all';
  let editingId = null;

  // â”€â”€ DBæ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function load() {
    showLoading(true);
    try {
      const data = await sbFetch(`${TABLE}?select=*&order=date.asc.nullslast`);
      records = data || [];
      renderTable();
    } catch(e) {
      showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Supabaseã®æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      console.error(e);
    } finally {
      showLoading(false);
    }
  }

  async function insertRecord(data) {
    return await sbFetch(TABLE, {
      method: 'POST',
      prefer: 'return=representation',
      body: JSON.stringify(data)
    });
  }

  async function updateRecord(id, data) {
    return await sbFetch(`${TABLE}?id=eq.${id}`, {
      method: 'PATCH',
      prefer: 'return=representation',
      body: JSON.stringify(data)
    });
  }

  async function deleteFromDB(id) {
    return await sbFetch(`${TABLE}?id=eq.${id}`, { method: 'DELETE' });
  }

  // â”€â”€ UI ãƒ˜ãƒ«ãƒ‘ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showLoading(on) {
    document.getElementById('loadingBar').style.display = on ? 'block' : 'none';
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
  }

  function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2500);
  }

  // â”€â”€ ãƒ•ã‚£ãƒ«ã‚¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setFilter(f, el) {
    currentFilter = f;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    renderTable();
  }

  function getFiltered() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    return records.filter(r => {
      const matchFilter = currentFilter === 'all' || r.status === currentFilter;
      const matchSearch = !q || [r.title, r.organizer, r.place, r.memo].some(f => (f||'').toLowerCase().includes(q));
      return matchFilter && matchSearch;
    }).sort((a,b) => (a.date||'').localeCompare(b.date||''));
  }

  // â”€â”€ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function formatDate(dt) {
    if (!dt) return 'â€”';
    const d = new Date(dt);
    if (isNaN(d)) return dt;
    const y = d.getFullYear();
    const mo = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    const wd = days[d.getDay()];
    const h = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${y}/${mo}/${da}ï¼ˆ${wd}ï¼‰${h}:${mi}`;
  }

  function formatDeadline(ds) {
    if (!ds) return '<span style="color:var(--text-muted)">â€”</span>';
    const today = new Date();
    today.setHours(0,0,0,0);
    const d = new Date(ds);
    const diff = Math.round((d - today) / 86400000);
    const [y,mo,da] = ds.split('-');
    const label = `${y}/${mo}/${da}`;
    if (diff < 0) return `<span class="deadline-warn">âš  ${label}ï¼ˆæœŸé™è¶…éï¼‰</span>`;
    if (diff <= 7) return `<span class="deadline-near">â° ${label}ï¼ˆã‚ã¨${diff}æ—¥ï¼‰</span>`;
    return label;
  }

  function esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // â”€â”€ ãƒ†ãƒ¼ãƒ–ãƒ«æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable() {
    const filtered = getFiltered();
    const tbody = document.getElementById('tableBody');
    const empty = document.getElementById('emptyState');

    document.getElementById('stat-total').textContent = records.length;
    document.getElementById('stat-kentou').textContent = records.filter(r=>r.status==='æ¤œè¨ä¸­').length;
    document.getElementById('stat-kakutei').textContent = records.filter(r=>r.status==='ç¢ºå®š').length;
    document.getElementById('stat-kanryo').textContent = records.filter(r=>r.status==='å®Œäº†').length;
    document.getElementById('stat-jirai').textContent = records.filter(r=>r.status==='è¾é€€').length;

    if (filtered.length === 0) {
      tbody.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    tbody.innerHTML = filtered.map(r => `
      <tr onclick="openDetail(${r.id})">
        <td><div class="td-title">${formatDate(r.date)}</div></td>
        <td><span class="cat-badge cat-${r.category||'ç™»å£‡'}">${r.category||'ç™»å£‡'}</span></td>
        <td><div class="td-title">${esc(r.title)}</div></td>
        <td>
          <div>${esc(r.organizer)}</div>
          <div class="td-sub">${esc(r.contact||'')}</div>
        </td>
        <td>${esc(r.place||'â€”')}</td>
        <td>${esc(r.fee||'â€”')}</td>
        <td>${formatDeadline(r.deadline)}</td>
        <td><span class="badge badge-${r.status}">${r.status}</span></td>
        <td onclick="event.stopPropagation()">
          <div class="actions">
            <button class="btn-edit" onclick="openEdit(${r.id})">ç·¨é›†</button>
            <button class="btn-del" onclick="deleteRecord(${r.id})">å‰Šé™¤</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  // â”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openModal(id = null) {
    editingId = id;
    const modal = document.getElementById('modalOverlay');
    const titleEl = document.getElementById('modalTitle');
    const fields = ['title','category','organizer','contact','date','place','fee','deadline','status','memo'];

    if (id) {
      const r = records.find(x => x.id === id);
      titleEl.textContent = 'ç™»å£‡ä¾é ¼ã‚’ç·¨é›†';
      fields.forEach(f => {
        const el = document.getElementById('f-'+f);
        if (!el) return;
        if (f === 'date' && r[f]) {
          // datetime-local needs format YYYY-MM-DDTHH:MM
          el.value = r[f].slice(0,16);
        } else {
          el.value = r[f] || '';
        }
      });
    } else {
      titleEl.textContent = 'ç™»å£‡ä¾é ¼ã‚’è¿½åŠ ';
      fields.forEach(f => {
        const el = document.getElementById('f-'+f);
        if (!el) return;
        el.value = f === 'status' ? 'æ¤œè¨ä¸­' : f === 'category' ? 'ç™»å£‡' : '';
      });
    }
    modal.classList.add('open');
  }

  function openEdit(id) { openModal(id); }
  function openDetail(id) { openModal(id); }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('open');
    editingId = null;
  }

  function handleOverlayClick(e) {
    if (e.target === document.getElementById('modalOverlay')) closeModal();
  }

  // â”€â”€ ä¿å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveRecord() {
    const get = id => document.getElementById('f-'+id).value.trim();
    const title = get('title');
    const organizer = get('organizer');
    if (!title) { alert('ãƒ†ãƒ¼ãƒãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (!organizer) { alert('ä¾é ¼å…ƒãƒ»ä¸»å‚¬è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    const data = {
      title, organizer,
      category: get('category') || 'ç™»å£‡',
      contact: get('contact') || null,
      date: get('date') || null,
      place: get('place') || null,
      fee: get('fee') || null,
      deadline: get('deadline') || null,
      status: get('status'),
      memo: get('memo') || null
    };

    const btn = document.querySelector('.btn-save');
    btn.textContent = 'ä¿å­˜ä¸­...';
    btn.disabled = true;

    try {
      if (editingId) {
        const updated = await updateRecord(editingId, data);
        const idx = records.findIndex(r => r.id === editingId);
        records[idx] = (updated && updated[0]) ? updated[0] : { ...records[idx], ...data };
        showToast('âœ“ æ›´æ–°ã—ã¾ã—ãŸ');
      } else {
        const created = await insertRecord(data);
        if (created && created[0]) records.push(created[0]);
        showToast('âœ“ è¿½åŠ ã—ã¾ã—ãŸ');
      }
      renderTable();
      closeModal();
    } catch(e) {
      showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      console.error(e);
    } finally {
      btn.textContent = 'ä¿å­˜ã™ã‚‹';
      btn.disabled = false;
    }
  }

  // â”€â”€ å‰Šé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function deleteRecord(id) {
    if (!confirm('ã“ã®ç™»å£‡ä¾é ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    try {
      await deleteFromDB(id);
      records = records.filter(r => r.id !== id);
      renderTable();
      showToast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
    } catch(e) {
      showError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  }

  // â”€â”€ èµ·å‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  load();
</script>
</body>
</html>
